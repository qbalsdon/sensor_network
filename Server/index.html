<!doctype html>
<html>

<head>
    <title>Line Chart</title>
    <script src="scripts/Chart.bundle.js"></script>
    <script src="scripts/utils.js"></script>
    <script language="javascript">

    const COLOURS = ["#e6194b", "#3cb44b", "#ffe119", "#0082c8", "#f58231", "#911eb4", "#46f0f0", "#d2f53c", "#fabebe", "#e6beff"];

    function loadData() {
        var url = window.location.href;
        var arr = url.split("/");
        var ipStr = arr[0] + "//" + arr[2];
        var xhttp = new XMLHttpRequest();

        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status >= 200 && this.status < 300) {
                parseReportData(JSON.parse(this.responseText));
            }
        };
        xhttp.open("GET", ipStr + "/data", true);
        xhttp.send();
    }

    function pad(n) {
        return (n < 10) ? ("0" + n) : n;
    }

    function getColour(data, mac) {
        for (var i = 0; i < data.devices.length; i++) {
            if (data.devices[i].mac == mac) return COLOURS[data.devices[i].colourIndex];
        } 
        return -1;
    }

    function parseReportData(response) {
        var dataSetArray = [];
        var labelArray = [];
        var colour = getColour(response, response.data[0].mac);
        updateControls(response.devices);
        dataSetArray.push({label: "Sensor 1", backGroundColor: colour, borderColor: colour, data: [], fill: false}); 
        var currentIndex = 0;
        var currentMac = response.data[0].mac;
        for (var i = 0; i < response.data.length; i++) {
           if (response.data[i].mac != currentMac) {
              currentIndex++;
              currentMac = response.data[i].mac;
              colour = getColour(response, currentMac);
              dataSetArray.push({label: "Sensor " + (currentIndex + 1), backGroundColor: colour, borderColor: colour, data: [], fill: false});
           }

           if (currentIndex == 0) {
               var date = new Date();
               date.setTime(Date.parse(response.data[i].timeStamp));

               var min = date.getUTCMinutes();
               var hour = date.getUTCHours();
               labelArray.push(pad(hour) + ":" + pad(min));
           } 
           dataSetArray[currentIndex].data.push(response.data[i].temperature);
        } 
        updateChart("Today's Temperature", labelArray, dataSetArray);
    }

    function updateControls(deviceList) {
        var size = 56;
        var divisor = 5;
        var list = "<table>";
        for (var i = 0; i < deviceList.length; i++) {
           list += "<tr><td>";
           list += "<img src='images/thermometer.png' style = 'width:" + size + "px; height: " + size + "px; background: " + COLOURS[deviceList[i].colourIndex] + "; -moz-border-radius: " + (size / divisor) + "px; -webkit-border-radius: " + (size / divisor) + "px; border-radius: 70px;'>";
           list += "</td><td>Blink!</td></tr>" 
        }
        list += "</table>";
        document.getElementById("control").innerHTML = list;
    }

    function updateChart(titleText, labelArray, dataSetArray) {
        var config = {
            type: 'line',
            data: {
                labels: labelArray,
                datasets: dataSetArray
            },
            options: {
                responsive: true,
                title:{
                    display:true,
                    text: titleText
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Temperature Âºc'
                        }
                    }]
                }
            }
        };

        var ctx = document.getElementById("canvas").getContext("2d");
        window.myLine = new Chart(ctx, config);
    }
    </script>
    <style>
    canvas{
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    </style>
</head>

<body>
    <div style="width:75%;float:left;">
        <canvas id="canvas"></canvas>
    </div>
    <div style="width:25%;float:left;" id="control">
       <ul> <li> One! </li>
       <li> Two! </li></ul> 
    </div>
    <br>
    <br>
    <script>
        window.onload = function() {
            loadData();
        };
    </script>
</body>

</html>
